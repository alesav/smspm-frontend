---
// Navigation Component
interface Props {
  lang?: string; // Allow passing language from parent
}

const { lang: propLang } = Astro.props;
const { pathname } = Astro.url;

// Detect language from prop (for SSR pages) or path, default to 'en'
const langMatch = pathname.match(/^\/([a-z]{2})(\/|$)/);
const detectedFromPath = langMatch ? langMatch[1] : null;
const lang = (propLang || detectedFromPath || "en") as keyof typeof translations;
const isEn = lang === "en";

// Get the current page path without language prefix
const getPagePath = () => {
  const pathWithoutLang = pathname.replace(/^\/[a-z]{2}(\/|$)/, '/') || '/';
  return pathWithoutLang === '//' ? '/' : pathWithoutLang;
};

const currentPagePath = getPagePath();

// Define localized paths - ALL languages including English get language prefix
const getLocalizedPath = (path: string) => {
  return `/${lang}${path}`;
};

// URL mapping for localized pricing pages
const pricingUrls: Record<string, string> = {
  'en': 'prices',
  'et': 'sms-hinnad',
  'ru': 'sms-ceny',
  'es': 'precios-sms',
  'de': 'sms-preise',
  'fr': 'prix-sms',
  'lv': 'sms-cenas',
  'lt': 'sms-kainos'
};

// URL prefix mapping for country pages
const countryUrlPrefixes: Record<string, string> = {
  'en': 'send-sms-',
  'et': 'saada-sms-',
  'ru': 'otpravit-sms-',
  'es': 'enviar-sms-',
  'de': 'sms-senden-',
  'fr': 'envoyer-sms-',
  'lv': 'sutit-sms-',
  'lt': 'siusti-sms-'
};

// Import country metadata for slug conversion
const metadataModule = await import("../../data/country-metadata.js");
const COUNTRY_METADATA = metadataModule.COUNTRY_METADATA as any;

// Helper function to find country by slug in any language
const findCountryBySlug = (slug: string): string | null => {
  for (const [countryName, metadata] of Object.entries(COUNTRY_METADATA)) {
    const allSlugs = [
      metadata.slug,
      metadata.slug_en,
      metadata.slug_et,
      metadata.slug_ru,
      metadata.slug_es,
      metadata.slug_de,
      metadata.slug_fr,
      metadata.slug_lv,
      metadata.slug_lt
    ].filter(Boolean);
    
    if (allSlugs.includes(slug)) {
      return countryName;
    }
  }
  return null;
};

// Generate language switch URLs that preserve current page
const getLanguageUrl = (targetLang: string) => {
  // For homepage
  if (pathname === "/" || pathname === `/${lang}` || pathname === `/${lang}/`) {
    return `/${targetLang}`;
  }
  
  // Check if current page is a pricing page (any of the localized pricing URLs)
  const isPricingPage = Object.values(pricingUrls).some(url => pathname.includes(`/${url}`)) || 
                        pathname.includes("/countries") || 
                        pathname.includes("/hinnad");
  
  if (isPricingPage) {
    return `/${targetLang}/${pricingUrls[targetLang] || 'prices'}`;
  }
  
  if (pathname.includes("/country/")) {
    // Extract the slug from the current URL (remove language and prefix)
    const urlParts = pathname.split('/country/')[1];
    if (urlParts) {
      // Remove the URL prefix to get just the slug
      let currentSlug = urlParts;
      for (const prefix of Object.values(countryUrlPrefixes)) {
        if (currentSlug.startsWith(prefix)) {
          currentSlug = currentSlug.substring(prefix.length);
          break;
        }
      }
      
      // Find which country this slug belongs to
      const countryName = findCountryBySlug(currentSlug);
      
      if (countryName && COUNTRY_METADATA[countryName]) {
        const metadata = COUNTRY_METADATA[countryName];
        const targetSlug = metadata[`slug_${targetLang}`] || metadata.slug;
        const targetPrefix = countryUrlPrefixes[targetLang] || 'send-sms-';
        return `/${targetLang}/country/${targetPrefix}${targetSlug}`;
      }
    }
    
    // Fallback: just change language but keep structure
    const pathWithoutLang = pathname.replace(/^\/[a-z]{2}(\/|$)/, '/');
    return `/${targetLang}${pathWithoutLang}`;
  }
  
  // For any other page, try to preserve the path structure
  const pathWithoutLang = pathname.replace(/^\/[a-z]{2}(\/|$)/, '/') || '/';
  return `/${targetLang}${pathWithoutLang}`;
};

const logoLink = `/${lang}`;
const pricingLink = `/${lang}/${pricingUrls[lang] || 'prices'}`;
const docsLink = "https://app.smspm.com/docs";
const supportLink = "https://smspm.freshdesk.com/support/tickets/new";
const loginLink = `https://app.smspm.com/${lang}/app/login`;
const registerLink = `https://app.smspm.com/${lang}/app/register`;

const translations = {
  en: {
    pricing: "Pricing",
    docs: "API Docs",
    support: "Support",
    login: "Login",
    startFree: "Start Free",
  },
  et: {
    pricing: "Hinnad",
    docs: "API-dokumendid",
    support: "Kasutajatugi",
    login: "Logi sisse",
    startFree: "Alusta tasuta",
  },
  ru: {
    pricing: "–¶–µ–Ω—ã",
    docs: "API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è",
    support: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
    login: "–í—Ö–æ–¥",
    startFree: "–ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ",
  },
  es: {
    pricing: "Precios",
    docs: "Docs API",
    support: "Soporte",
    login: "Iniciar sesi√≥n",
    startFree: "Empezar gratis",
  },
  de: {
    pricing: "Preise",
    docs: "API-Dokumente",
    support: "Support",
    login: "Anmelden",
    startFree: "Kostenlos starten",
  },
  fr: {
    pricing: "Tarifs",
    docs: "Docs API",
    support: "Support",
    login: "Connexion",
    startFree: "Commencer",
  },
  lv: {
    pricing: "Cenas",
    docs: "API dokumenti",
    support: "Atbalsts",
    login: "Pieteikties",
    startFree: "SƒÅkt bezmaksas",
  },
  lt: {
    pricing: "Kainos",
    docs: "API dokumentai",
    support: "Pagalba",
    login: "Prisijungti",
    startFree: "Pradƒóti",
  },
};

const t = translations[lang] || translations.en;
---

<!-- Navigation -->
<nav
  class="navbar fixed top-0 left-0 right-0 z-[1000] transition-all duration-300"
>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="nav-content flex items-center justify-between h-16 sm:h-[72px]">
      <div class="logo flex items-center">
        <a href={logoLink} class="flex items-center">
          <img
            src="/logo.png"
            alt="SMSPM Logo"
            class="logo-img h-8 sm:h-10 w-auto transition-all duration-300"
            width="300"
            height="97"
          />
        </a>
      </div>

      <div class="nav-links hidden lg:flex gap-6 xl:gap-8 items-center">
        <a
          href={pricingLink}
          class="text-dynamic-secondary hover:text-cyan transition-colors duration-150 font-medium text-sm xl:text-[15px] relative group"
        >
          {t.pricing}
          <span
            class="absolute bottom-[-4px] left-0 right-0 h-0.5 bg-gradient-1 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"
          ></span>
        </a>
        <a
          href={docsLink}
          class="text-dynamic-secondary hover:text-cyan transition-colors duration-150 font-medium text-sm xl:text-[15px] relative group"
        >
          {t.docs}
          <span
            class="absolute bottom-[-4px] left-0 right-0 h-0.5 bg-gradient-1 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"
          ></span>
        </a>
        <a
          href={supportLink}
          class="text-dynamic-secondary hover:text-cyan transition-colors duration-150 font-medium text-sm xl:text-[15px] relative group"
        >
          {t.support}
          <span
            class="absolute bottom-[-4px] left-0 right-0 h-0.5 bg-gradient-1 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"
          ></span>
        </a>
      </div>

      <div class="nav-actions flex items-center gap-2 sm:gap-3 md:gap-4">
        <!-- Language Selector -->
        <div class="language-selector relative">
          <button
            class="lang-btn flex items-center gap-1.5 sm:gap-2 px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 rounded-lg cursor-pointer text-xs sm:text-sm font-medium transition-all duration-150"
            id="langBtn"
          >
            <span class="flag text-base sm:text-xl">üåê</span>
            <span class="lang-text hidden xs:inline">{lang.toUpperCase()}</span>
            <svg
              class="lang-arrow w-2.5 h-2.5 sm:w-3 sm:h-3 transition-transform duration-150"
              viewBox="0 0 12 12"
              fill="none"
            >
              <path
                d="M2 4L6 8L10 4"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"></path>
            </svg>
          </button>
          <div
            class="lang-dropdown fixed sm:absolute top-16 sm:top-[calc(100%+8px)] right-0 left-0 sm:left-auto sm:right-0 sm:min-w-[180px] max-w-full sm:max-w-none p-2 rounded-none sm:rounded-xl shadow-xl opacity-0 invisible transform translate-y-[-8px] transition-all duration-300 z-[1001] max-h-[calc(100vh-4rem)] overflow-y-auto"
            id="langDropdown"
          >
            <!-- Debug info -->
            <!-- Current path: {pathname}, Current lang: {lang}, Is EN: {isEn} -->
            <a
              href={getLanguageUrl("en")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "en" ? "opacity-50" : ""}`}
              data-lang="en"
              aria-disabled={lang === "en" ? "true" : "false"}
              title={`Switch to English: ${getLanguageUrl("en")}`}
            >
              <span class="flag text-xl">üá¨üáß</span> English
            </a>
            <a
              href={getLanguageUrl("et")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "et" ? "opacity-50" : ""}`}
              data-lang="et"
              aria-disabled={lang === "et" ? "true" : "false"}
            >
              <span class="flag text-xl">üá™üá™</span> Eesti
            </a>
            <a
              href={getLanguageUrl("ru")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "ru" ? "opacity-50" : ""}`}
              data-lang="ru"
              aria-disabled={lang === "ru" ? "true" : "false"}
            >
              <span class="flag text-xl">üá∑üá∫</span> –†—É—Å—Å–∫–∏–π
            </a>
            <a
              href={getLanguageUrl("es")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "es" ? "opacity-50" : ""}`}
              data-lang="es"
              aria-disabled={lang === "es" ? "true" : "false"}
            >
              <span class="flag text-xl">üá™üá∏</span> Espa√±ol
            </a>
            <a
              href={getLanguageUrl("de")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "de" ? "opacity-50" : ""}`}
              data-lang="de"
              aria-disabled={lang === "de" ? "true" : "false"}
            >
              <span class="flag text-xl">üá©üá™</span> Deutsch
            </a>
            <a
              href={getLanguageUrl("fr")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "fr" ? "opacity-50" : ""}`}
              data-lang="fr"
              aria-disabled={lang === "fr" ? "true" : "false"}
            >
              <span class="flag text-xl">üá´üá∑</span> Fran√ßais
            </a>
            <a
              href={getLanguageUrl("lv")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "lv" ? "opacity-50" : ""}`}
              data-lang="lv"
              aria-disabled={lang === "lv" ? "true" : "false"}
            >
              <span class="flag text-xl">üá±üáª</span> Latvie≈°u
            </a>
            <a
              href={getLanguageUrl("lt")}
              class={`lang-option flex items-center gap-4 px-4 py-2 rounded-lg text-sm transition-all duration-150 ${lang === "lt" ? "opacity-50" : ""}`}
              data-lang="lt"
              aria-disabled={lang === "lt" ? "true" : "false"}
            >
              <span class="flag text-xl">üá±üáπ</span> Lietuvi≈≥
            </a>
          </div>
        </div>

        <!-- Dark Mode Toggle -->
        <button
          class="theme-toggle flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 md:w-11 md:h-11 rounded-lg cursor-pointer transition-all duration-300 relative overflow-hidden hover:-translate-y-0.5 hover:shadow-lg"
          id="themeToggle"
          aria-label="Toggle dark mode"
        >
          <svg
            class="sun-icon w-4 h-4 sm:w-5 sm:h-5 absolute transition-all duration-300"
            viewBox="0 0 24 24"
            fill="none"
          >
            <path
              d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
              stroke="currentColor"
              stroke-width="2"></path>
            <path
              d="M12 2V4M12 20V22M4.92993 4.92993L6.34393 6.34393M17.656 17.656L19.07 19.07M2 12H4M20 12H22M4.92993 19.07L6.34393 17.656M17.656 6.34393L19.07 4.92993"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"></path>
          </svg>
          <svg
            class="moon-icon w-4 h-4 sm:w-5 sm:h-5 absolute transition-all duration-300 opacity-0 rotate-180"
            viewBox="0 0 24 24"
            fill="none"
          >
            <path
              d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
              stroke="currentColor"
              stroke-width="2"></path>
          </svg>
        </button>

        <a
          href={loginLink}
          class="btn btn-secondary hidden lg:inline-flex text-sm xl:text-base px-3 xl:px-4 py-2">{t.login}</a
        >
        <a href={registerLink} class="btn btn-primary text-xs sm:text-sm md:text-base px-3 sm:px-4 md:px-6 py-2 md:py-2.5 whitespace-nowrap"
          >{t.startFree}</a
        >
      </div>

      <!-- Mobile Menu Button -->
      <button
        class="mobile-menu-btn lg:hidden flex flex-col gap-1 p-2 ml-2 rounded-lg transition-all duration-150"
        id="mobileMenuBtn"
        aria-label="Toggle mobile menu"
      >
        <span class="w-5 sm:w-6 h-0.5 bg-current transition-all duration-150"></span>
        <span class="w-5 sm:w-6 h-0.5 bg-current transition-all duration-150"></span>
        <span class="w-5 sm:w-6 h-0.5 bg-current transition-all duration-150"></span>
      </button>
    </div>

    <!-- Mobile Menu Overlay -->
    <div
      class="mobile-menu fixed inset-0 top-16 sm:top-[72px] opacity-0 invisible transition-all duration-300 lg:hidden z-[999]"
      id="mobileMenu"
    >
      <div class="mobile-menu-content h-full overflow-y-auto">
        <div class="container mx-auto px-4 py-6">
          <div class="flex flex-col gap-4">
            <a
              href={pricingLink}
              class="mobile-menu-link text-dynamic-primary hover:text-cyan transition-colors duration-150 font-medium text-lg py-3 border-b border-dynamic-secondary"
            >
              {t.pricing}
            </a>
            <a
              href={docsLink}
              class="mobile-menu-link text-dynamic-primary hover:text-cyan transition-colors duration-150 font-medium text-lg py-3 border-b border-dynamic-secondary"
            >
              {t.docs}
            </a>
            <a
              href={supportLink}
              class="mobile-menu-link text-dynamic-primary hover:text-cyan transition-colors duration-150 font-medium text-lg py-3 border-b border-dynamic-secondary"
            >
              {t.support}
            </a>
            <a
              href={loginLink}
              class="btn btn-secondary mt-4 justify-center">{t.login}</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<style>
  /* Mobile menu styling */
  .mobile-menu-content {
    background: var(--bg-primary);
    backdrop-filter: blur(12px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  [data-theme="dark"] .mobile-menu-content {
    background: rgba(10, 10, 10, 0.98);
    backdrop-filter: blur(12px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  /* Mobile menu hamburger color */
  .mobile-menu-btn span {
    background: var(--text-secondary);
  }

  /* Mobile menu visible state */
  .mobile-menu.show {
    opacity: 1;
    visibility: visible;
  }

  /* Enhance language selector hover */
  .language-selector:hover .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Show dropdown when triggered by JavaScript (mobile) */
  .lang-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Mobile language dropdown full width */
  @media (max-width: 640px) {
    .lang-dropdown.show {
      border-radius: 0;
    }
  }

  .lang-option:hover {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
  }

  /* Active language option styling */
  .lang-option.active {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
  }

  /* Mobile menu animation */
  .mobile-menu-btn.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  .mobile-menu-btn.active span:nth-child(2) {
    opacity: 0;
  }

  .mobile-menu-btn.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
  }

  /* Prevent body scroll when mobile menu is open */
  body.mobile-menu-open {
    overflow: hidden;
  }

  /* Custom breakpoint for xs screens */
  @media (min-width: 375px) {
    .xs\:inline {
      display: inline;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const langBtn = document.getElementById('langBtn');
    const langDropdown = document.getElementById('langDropdown');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    
    // Language selector functionality
    if (langBtn && langDropdown) {
      // Handle dropdown visibility on click for mobile
      langBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const isVisible = langDropdown.classList.contains('show');
        
        // Close mobile menu if open
        if (mobileMenu?.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          mobileMenuBtn?.classList.remove('active');
          document.body.classList.remove('mobile-menu-open');
        }
        
        if (isVisible) {
          langDropdown.classList.remove('show');
        } else {
          langDropdown.classList.add('show');
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        const target = e.target as HTMLElement;
        if (!langBtn.contains(target) && !langDropdown.contains(target)) {
          langDropdown.classList.remove('show');
        }
      });
      
      // Handle language option clicks - Store preference and navigate
      const langOptions = langDropdown.querySelectorAll('.lang-option');
      langOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          // Prevent navigation ONLY if it's the current language
          if (option.getAttribute('aria-disabled') === 'true') {
            e.preventDefault();
            e.stopPropagation();
            return;
          }
          
          // Store language preference in cookie (1 year)
          const selectedLang = option.getAttribute('data-lang');
          if (selectedLang) {
            document.cookie = `preferred-language=${selectedLang}; path=/; max-age=31536000; SameSite=Lax`;
          }
          
          // Close dropdown and let browser navigate
          langDropdown.classList.remove('show');
        });
      });
    }

    // Mobile menu functionality
    if (mobileMenuBtn && mobileMenu) {
      mobileMenuBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const isVisible = mobileMenu.classList.contains('show');
        
        // Close language dropdown if open
        if (langDropdown?.classList.contains('show')) {
          langDropdown.classList.remove('show');
        }
        
        if (isVisible) {
          mobileMenu.classList.remove('show');
          mobileMenuBtn.classList.remove('active');
          document.body.classList.remove('mobile-menu-open');
        } else {
          mobileMenu.classList.add('show');
          mobileMenuBtn.classList.add('active');
          document.body.classList.add('mobile-menu-open');
        }
      });

      // Close mobile menu when clicking on a link
      const mobileMenuLinks = mobileMenu.querySelectorAll('.mobile-menu-link, .btn');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
          mobileMenu.classList.remove('show');
          mobileMenuBtn.classList.remove('active');
          document.body.classList.remove('mobile-menu-open');
        });
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
        const target = e.target as HTMLElement;
        if (!mobileMenuBtn.contains(target) && !mobileMenu.contains(target)) {
          if (mobileMenu.classList.contains('show')) {
            mobileMenu.classList.remove('show');
            mobileMenuBtn.classList.remove('active');
            document.body.classList.remove('mobile-menu-open');
          }
        }
      });
    }
  });
</script>
