---
import { getEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import Navigation from "../../../components/Navigation.astro";
import CountryHero from "../../../components/country/CountryHero.astro";
import CountryInfo from "../../../components/country/CountryInfo.astro";
import MobileProviders from "../../../components/country/MobileProviders.astro";
import UseCases from "../../../components/country/UseCases.astro";
import ApiIntegration from "../../../components/country/ApiIntegration.astro";
import RegulatoryInfo from "../../../components/country/RegulatoryInfo.astro";
import CountryFAQ from "../../../components/country/CountryFAQ.astro";
import Footer from "../../../components/Footer.astro";
import {
    fetchPricingData,
    getCountryPricing,
    type CountryData,
    type CountryProvider,
} from "../../../utils/kv-pricing";
import {
    getCountryConfig,
    getAvailableCountries,
    getCountryCodeByName,
} from "../../../utils/country-data";

export async function getStaticPaths() {
    const pricingData = await fetchPricingData();
    const availableCountries = getAvailableCountries();
    const pricingCountries = new Set<string>();

    // Extract unique countries from pricing keys (e.g., "Estonia - Telia" -> "Estonia")
    Object.keys(pricingData).forEach((key) => {
        const [countryName] = key.split(" - ");
        if (countryName) {
            pricingCountries.add(countryName);
        }
    });

    // Create paths for all countries found in pricing + manual config
    const allCountries = new Set([
        ...availableCountries
            .map((c) => {
                const config = getCountryConfig(c);
                return config ? config.name : "";
            })
            .filter(Boolean),
        ...pricingCountries,
    ]);

    return Array.from(allCountries).flatMap((countryName) => {
        return [
            {
                params: {
                    lang: "en",
                    slug: countryName.toLowerCase().replace(/ /g, "-"),
                },
                props: { countryName },
            },
            // Add other languages here if/when needed
        ];
    });
}

const { countryName } = Astro.props;
const { lang } = Astro.params;

// 1. Fetch Pricing (Always Source of Truth)
const pricingData = await fetchPricingData();
const providers = getCountryPricing(pricingData, countryName);
const startingPrice =
    providers.length > 0 ? Math.min(...providers.map((p) => p.price)) : 0;

// 2. Try to get Manual Content Override (Markdown)
// We look for a file named like 'estonia' in the 'countries' collection
const slugName = countryName.toLowerCase().replace(/ /g, "-");
let manualContent = null;
try {
    // We check if the collection relies on existing files.
    // If the collection dir is empty, Astro might error or return undefined.
    manualContent = await getEntry("countries" as any, slugName);
} catch (e) {
    // Collection might not exist yet if no files are present
    console.log(`No manual content for ${slugName}`);
}

// 3. Try to get Country Config (TS Object or Fallback Metadata)
const code = getCountryCodeByName(countryName);
const config = getCountryConfig(code);

// 4. Construct Final Country Data
// Priority: Markdown Content > Manual Config (TS) > Metadata Fallback > Generic Fallback
const country: CountryData = {
    code: config?.code || code,
    name: countryName,
    flag: config?.flag || "üåç",
    population: config?.population || "Unknown",
    mobileUsers: config?.mobileUsers || "Unknown",
    mobilePenetration: config?.mobilePenetration || "Unknown",
    networkCoverage: config?.networkCoverage || "Unknown",
    timezone: config?.timezone || "UTC",
    currency: config?.currency || "EUR",
    callingCode: config?.callingCode || "Unknown",
    startingPrice,
    providers,
    marketDescription:
        manualContent?.data?.introText ||
        config?.marketDescription ||
        `Send SMS to ${countryName} with reliable delivery and competitive pricing via SMSPM's global gateway.`,
    useCases: config?.useCases || [
        {
            title: "Notifications",
            description: `Reliable SMS notifications for ${countryName} customers.`,
            examples: ["Order updates", "Alerts", "Reminders"],
            icon: "fas fa-bell",
        },
    ],
    regulations: config?.regulations || [],
    stats: config?.stats || {
        deliveryRate: "99.9%",
        responseTime: "<200ms",
        uptime: "99.99%",
    },
    seo: {
        title:
            manualContent?.data?.metaTitle ||
            config?.seo?.title ||
            `Send SMS to ${countryName} - Bulk SMS API with ${startingPrice} Pricing`,
        description:
            manualContent?.data?.metaDescription ||
            config?.seo?.description ||
            `Connect with ${config?.mobileUsers || "mobile"} users in ${countryName}. 99.9% delivery rate, direct connections, and pricing from ${config?.currency === "EUR" ? "‚Ç¨" : config?.currency === "GBP" ? "¬£" : "$"}${startingPrice} per message.`,
        keywords: config?.seo?.keywords || [
            `SMS ${countryName}`,
            `bulk SMS ${countryName}`,
            `SMS API ${countryName}`,
            `send messages to ${countryName}`,
        ],
    },
};

// Generate Structured Data
const structuredData = {
    "@context": "https://schema.org",
    "@type": "Service",
    name: `SMS Service to ${countryName}`,
    description:
        manualContent?.data?.metaDescription ||
        config?.seo?.description ||
        `Send SMS to ${countryName} with 99.9% delivery rate.`,
    provider: {
        "@type": "Organization",
        name: "SMSPM",
        url: "https://smspm.com",
    },
    areaServed: {
        "@type": "Country",
        name: countryName,
    },
    offers: providers.map((provider) => ({
        "@type": "Offer",
        name: `SMS via ${provider.name}`,
        price: provider.price,
        priceCurrency: config?.currency || "EUR",
    })),
};
---

<Layout
    title={country.seo.title}
    description={country.seo.description}
    image={`/images/sms-${country.code}-og.jpg`}
>
    <head>
        <meta name="keywords" content={country.seo.keywords.join(", ")} />
        <link
            rel="canonical"
            href={`https://smspm.com/${lang}/country/send-sms-${countryName.toLowerCase().replace(/ /g, "-")}`}
        />
        <script
            type="application/ld+json"
            is:inline
            set:html={JSON.stringify(structuredData)}
        />
        <meta name="geo.region" content={country.code.toUpperCase()} />
        <meta name="geo.country" content={country.code.toUpperCase()} />
        <meta name="geo.placename" content={country.name} />
    </head>

    <Navigation />

    <main>
        <CountryHero country={country} />
        <CountryInfo country={country} />
        <MobileProviders country={country} />
        <UseCases country={country} />
        <ApiIntegration country={country} />
        <CountryFAQ country={country} />
        <RegulatoryInfo country={country} />

        <!-- CTA Section -->
        <section class="cta-section relative py-16 lg:py-24 overflow-hidden">
            <div
                class="cta-gradient-bg absolute top-0 left-0 right-0 bottom-0 -z-10"
            >
            </div>
            <div class="container mx-auto px-8">
                <div class="cta-content text-center max-w-[800px] mx-auto">
                    <h2
                        class="cta-title text-4xl lg:text-6xl font-extrabold text-white mb-4"
                    >
                        Ready to Send SMS to {country.name}?
                    </h2>
                    <p class="cta-subtitle text-xl text-white/90 mb-8">
                        Join thousands of businesses using SMSPM for reliable
                        message delivery
                    </p>
                    <div
                        class="cta-actions flex flex-col sm:flex-row justify-center gap-4 mb-6"
                    >
                        <a
                            href="https://app.smspm.com/app/register"
                            class="btn btn-primary btn-large"
                        >
                            Start Free Trial
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 20 20"
                                fill="none"
                            >
                                <path
                                    d="M7 3L15 10L7 17"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"></path>
                            </svg>
                        </a>
                        <a
                            href="/demo"
                            class="btn btn-secondary btn-large light text-white border-white/30 hover:bg-white/10"
                        >
                            Request Demo
                        </a>
                    </div>
                    <p class="cta-note text-sm text-white/70">
                        No credit card required ¬∑ 50 free messages ¬∑ Full API
                        access
                    </p>
                </div>
            </div>
        </section>
    </main>

    <Footer />
</Layout>

<script is:inline>
    // Image fallback handling and interactive elements
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".provider-card img").forEach((img) => {
            img.addEventListener("error", function () {
                this.style.display = "none";
                const fallback = this.nextElementSibling;
                if (fallback && fallback.style) {
                    fallback.style.display = "flex";
                }
            });
        });
    });
</script>

<style>
    .hero-gradient-bg {
        background:
            radial-gradient(
                circle at 20% 50%,
                rgba(38, 198, 218, 0.15) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 80% 20%,
                rgba(13, 71, 161, 0.15) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 50% 80%,
                rgba(124, 77, 255, 0.1) 0%,
                transparent 50%
            );
    }
    [data-theme="dark"] .hero-gradient-bg {
        background:
            radial-gradient(
                circle at 20% 50%,
                rgba(38, 198, 218, 0.25) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 80% 20%,
                rgba(13, 71, 161, 0.25) 0%,
                transparent 50%
            ),
            radial-gradient(
                circle at 50% 80%,
                rgba(124, 77, 255, 0.2) 0%,
                transparent 50%
            );
    }
    .cta-gradient-bg {
        background: linear-gradient(
            135deg,
            #26c6da 0%,
            #7c4dff 50%,
            #0d47a1 100%
        );
    }
    .provider-card img[style*="display: none"] + div {
        display: flex !important;
    }
</style>
