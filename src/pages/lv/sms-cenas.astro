---
import Layout from "../../layouts/Layout.astro";
import Navigation from "../../components/Navigation.astro";
import Footer from "../../components/Footer.astro";
import {
    getCountryCodeByName,
    getCountryConfig,
} from "../../utils/country-data";
import { fetchPricingData } from "../../utils/kv-pricing";

const lang = 'lv';

// Import localization data
const metadataRaw = await import("../../../data/country-metadata.js");
const COUNTRY_METADATA = metadataRaw.COUNTRY_METADATA as any;

const translations = {
    en: {
        title: "Global SMS Pricing - Compare Rates for 190+ Countries",
        description:
            "View competitive SMS pricing for 190+ countries. Direct carrier connections, high delivery rates, and transparent rates.",
        heroBadge: "Global Coverage",
        heroTitle: "SMS Pricing",
        heroDirectory: "Directory",
        heroSubtitle: (total: number) =>
            `Transparent pricing for ${total} countries through direct carrier routes.`,
        searchPlaceholder: "Search for a country...",
        ISO: "ISO",
        startsFrom: "Starts from",
        noResultsTitle: "No countries found",
        noResultsText: "Try a different search term or browse the full list.",
    },
    et: {
        title: "Globaalsed SMS hinnad - v√µrdle hindu 190+ riigis",
        description:
            "Vaata rannatuid SMS-hindu 190+ riigis. Otsesed operaatori √ºhendused, k√µrge k√§ttetoimetamise m√§√§r ja l√§bipaistvad hinnad.",
        heroBadge: "Globaalne katvus",
        heroTitle: "SMS-ide",
        heroDirectory: "hinnakiri",
        heroSubtitle: (total: number) =>
            `L√§bipaistvad hinnad ${total} riigi jaoks l√§bi otseste operaatorkanalite.`,
        searchPlaceholder: "Otsi riiki...",
        ISO: "ISO",
        startsFrom: "Alates",
        noResultsTitle: "Riike ei leitud",
        noResultsText:
            "Proovige muud otsingus√µna v√µi sirvige t√§ielikku loendit.",
    },
    ru: {
        title: "–ú–∏—Ä–æ–≤—ã–µ —Ü–µ–Ω—ã –Ω–∞ SMS ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è 190+ —Å—Ç—Ä–∞–Ω",
        description:
            "–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ SMS –≤ 190+ —Å—Ç—Ä–∞–Ω–∞—Ö. –ü—Ä—è–º—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º, –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã.",
        heroBadge: "–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ö–≤–∞—Ç",
        heroTitle: "–¶–µ–Ω—ã –Ω–∞",
        heroDirectory: "SMS",
        heroSubtitle: (total: number) =>
            `–ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è ${total} —Å—Ç—Ä–∞–Ω —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ –∫–∞–Ω–∞–ª—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤.`,
        searchPlaceholder: "–ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω—ã...",
        ISO: "ISO",
        startsFrom: "–û—Ç",
        noResultsTitle: "–°—Ç—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
        noResultsText:
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫.",
    },
    es: {
        title: "Precios globales de SMS: compare tarifas para m√°s de 190 pa√≠ses",
        description:
            "Vea precios competitivos de SMS para m√°s de 190 pa√≠ses. Conexiones directas con operadores, altas tasas de entrega y tarifas transparentes.",
        heroBadge: "Cobertura Global",
        heroTitle: "Directorio de",
        heroDirectory: "Precios SMS",
        heroSubtitle: (total: number) =>
            `Precios transparentes para ${total} pa√≠ses a trav√©s de rutas directas de operadores.`,
        searchPlaceholder: "Buscar un pa√≠s...",
        ISO: "ISO",
        startsFrom: "Desde",
        noResultsTitle: "No se encontraron pa√≠ses",
        noResultsText:
            "Pruebe con un t√©rmino de b√∫squeda diferente o explore la lista completa.",
    },
    de: {
        title: "Globale SMS-Preise ‚Äì Vergleichen Sie Tarife f√ºr √ºber 190 L√§nder",
        description:
            "Sehen Sie sich wettbewerbsf√§hige SMS-Preise f√ºr √ºber 190 L√§nder an. Direkte Carrier-Verbindungen, hohe Zustellraten und transparente Tarife.",
        heroBadge: "Globale Abdeckung",
        heroTitle: "SMS-Preis",
        heroDirectory: "Verzeichnis",
        heroSubtitle: (total: number) =>
            `Transparente Preise f√ºr ${total} L√§nder √ºber direkte Betreiberrouten.`,
        searchPlaceholder: "Suche nach einem Land...",
        ISO: "ISO",
        startsFrom: "Ab",
        noResultsTitle: "Keine L√§nder gefunden",
        noResultsText:
            "Versuchen Sie es mit einem anderen Suchbegriff oder durchsuchen Sie die vollst√§ndige Liste.",
    },
    fr: {
        title: "Tarifs SMS mondiaux - Comparez les tarifs de plus de 190 pays",
        description:
            "Consultez des tarifs SMS comp√©titifs pour plus de 190 pays. Connexions directes aux op√©rateurs, taux de d√©livrabilit√© √©lev√©s et tarifs transparents.",
        heroBadge: "Couverture Mondiale",
        heroTitle: "R√©pertoire des",
        heroDirectory: "Tarifs SMS",
        heroSubtitle: (total: number) =>
            `Tarification transparente pour ${total} pays via des routes directes avec les op√©rateurs.`,
        searchPlaceholder: "Rechercher un pays...",
        ISO: "ISO",
        startsFrom: "√Ä partir de",
        noResultsTitle: "Aucun pays trouv√©",
        noResultsText:
            "Essayez un autre terme de recherche ou parcourez la liste compl√®te.",
    },
    lv: {
        title: "GlobƒÅlƒÅs SMS cenas ‚Äî salƒ´dziniet tarifus vairƒÅk nekƒÅ 190 valstƒ´s",
        description:
            "Skatiet konkurƒìtspƒìjƒ´gas SMS cenas vairƒÅk nekƒÅ 190 valstƒ´s. Tie≈°ie operatoru savienojumi, augsts piegƒÅdes lƒ´menis un caurspƒ´dƒ´gi tarifi.",
        heroBadge: "GlobƒÅls pƒÅrklƒÅjums",
        heroTitle: "SMS cenu",
        heroDirectory: "katalogs",
        heroSubtitle: (total: number) =>
            `Caurspƒ´dƒ´ga cenu noteik≈°ana ${total} valstƒ´m, izmantojot tie≈°os operatoru mar≈°rutus.`,
        searchPlaceholder: "Meklƒìt valsti...",
        ISO: "ISO",
        startsFrom: "Mƒìƒ£iniet",
        noResultsTitle: "Valstis nav atrastas",
        noResultsText:
            "Mƒìƒ£iniet citu meklƒì≈°anas terminu vai pƒÅrl≈´kojiet pilno sarakstu.",
    },
    lt: {
        title: "Pasaulinƒós SMS kainos ‚Äì palyginkite ƒØkainius 190+ ≈°ali≈≥",
        description:
            "Per≈æi≈´rƒókite konkurencingas SMS kainas 190+ ≈°ali≈≥. Tiesioginis ry≈°ys su operatoriais, didelis pristatymo lygis ir skaidr≈´s tarifai.",
        heroBadge: "Visuotinis padengimas",
        heroTitle: "SMS kain≈≥",
        heroDirectory: "katalogas",
        heroSubtitle: (total: number) =>
            `Skaidri kainodara ${total} ≈°alims per tiesioginius operatori≈≥ mar≈°rutus.`,
        searchPlaceholder: "Ie≈°koti ≈°alies...",
        ISO: "ISO",
        startsFrom: "Nuo",
        noResultsTitle: "≈†ali≈≥ nerasta",
        noResultsText:
            "I≈°bandykite kitƒÖ paie≈°kos terminƒÖ arba nar≈°ykite visƒÖ sƒÖra≈°ƒÖ.",
    },
};

const t = (translations as any)[lang] || translations.en;

// Fetch unique countries and calculate starting prices
const pricingData = await fetchPricingData();
const countriesMap = new Map();

Object.keys(pricingData).forEach((key) => {
    const [countryName] = key.split(" - ");
    if (countryName) {
        const price = (pricingData as any)[key].p;
        if (
            !countriesMap.has(countryName) ||
            price < countriesMap.get(countryName)
        ) {
            countriesMap.set(countryName, price);
        }
    }
});

const countries = Array.from(countriesMap.entries())
    .map(([englishName, startingPrice]) => {
        const code = getCountryCodeByName(englishName);
        const config = getCountryConfig(code);

        // Find metadata for localization
        const metadata = COUNTRY_METADATA[englishName] || null;
        const localizedName = metadata
            ? metadata[`name_${lang}`] || metadata.name || englishName
            : englishName;
        const localizedSlug = metadata
            ? metadata[`slug_${lang}`] || metadata.slug
            : englishName.toLowerCase().replace(/ /g, "-");
        // URL prefix mapping for localized country page URLs
        const urlPrefixMap: Record<string, string> = {
            'en': 'send-sms-',
            'et': 'saada-sms-',
            'ru': 'otpravit-sms-',
            'es': 'enviar-sms-',
            'de': 'sms-senden-',
            'fr': 'envoyer-sms-',
            'lv': 'sutit-sms-',
            'lt': 'siusti-sms-'
        };
        const urlPrefix = urlPrefixMap[lang as string] || 'send-sms-';

        return {
            name: localizedName,
            englishName,
            code,
            startingPrice,
            flag: config?.flag || metadata?.flag || "üåç",
            slug: localizedSlug,
            urlPrefix,
            currency: config?.currency || metadata?.currency || "EUR",
        };
    })
    .sort((a, b) => a.name.localeCompare(b.name));

const totalCountries = countries.length;
---

<Layout title={t.title} description={t.description}>
    <Navigation />

    <main class="pt-[120px] pb-20">
        <!-- Hero Section -->
        <section class="countries-hero mb-16">
            <div class="container mx-auto px-8 text-center">
                <span
                    class="section-badge inline-flex px-6 py-2 bg-cyan/10 border border-cyan/30 rounded-full text-sm text-cyan font-semibold mb-6"
                    >{t.heroBadge}</span
                >
                <h1
                    class="text-4xl lg:text-7xl font-extrabold mb-6 tracking-tight text-dynamic-primary"
                >
                    {t.heroTitle}
                    <span class="gradient-text">{t.heroDirectory}</span>
                </h1>
                <p
                    class="text-xl text-dynamic-secondary max-w-2xl mx-auto mb-12"
                >
                    {t.heroSubtitle(totalCountries)}
                </p>

                <!-- Search Input (Client-side handled) -->
                <div class="max-w-xl mx-auto relative group">
                    <div
                        class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none text-dynamic-tertiary"
                    >
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                    <input
                        type="text"
                        id="countrySearch"
                        placeholder={t.searchPlaceholder}
                        class="w-full bg-dynamic-secondary border-2 border-dynamic-primary focus:border-cyan text-dynamic-primary rounded-2xl py-6 pl-16 pr-6 outline-none transition-all text-lg shadow-xl"
                    />
                </div>
            </div>
        </section>

        <!-- Countries Grid -->
        <section class="countries-grid section-transition">
            <div class="container mx-auto px-8">
                <div
                    id="countriesList"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
                >
                    {
                        countries.map((country) => (
                            <a
                                href={`/${lang}/country/${country.urlPrefix}${country.slug}`}
                                class="country-item group bg-dynamic-primary border border-dynamic-primary rounded-2xl p-6 hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 flex items-center justify-between"
                                data-name={country.name.toLowerCase()}
                                data-english-name={country.englishName.toLowerCase()}
                            >
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-dynamic-secondary flex items-center justify-center text-2xl shadow-inner group-hover:scale-110 transition-transform duration-500">
                                        {country.flag}
                                    </div>
                                    <div class="country-info">
                                        <h3 class="font-bold text-lg text-dynamic-primary group-hover:text-cyan transition-colors">
                                            {country.name}
                                        </h3>
                                        <p class="text-xs text-dynamic-tertiary uppercase tracking-wider">
                                            {t.ISO}:{" "}
                                            {country.code.toUpperCase()}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="block text-sm text-dynamic-tertiary">
                                        {t.startsFrom}
                                    </span>
                                    <span class="text-lg font-bold text-dynamic-primary group-hover:text-cyan transition-colors">
                                        {country.currency === "EUR"
                                            ? "‚Ç¨"
                                            : country.currency === "GBP"
                                              ? "¬£"
                                              : "$"}
                                        {country.startingPrice.toFixed(3)}
                                    </span>
                                </div>
                            </a>
                        ))
                    }
                </div>

                <!-- No Results State -->
                <div id="noResults" class="hidden text-center py-20">
                    <div class="text-6xl mb-6">üîç</div>
                    <h3 class="text-2xl font-bold text-dynamic-primary mb-2">
                        {t.noResultsTitle}
                    </h3>
                    <p class="text-dynamic-secondary">
                        {t.noResultsText}
                    </p>
                </div>
            </div>
        </section>
    </main>

    <Footer />
</Layout>

<script>
    const searchInput = document.getElementById(
        "countrySearch",
    ) as HTMLInputElement;
    const countriesList = document.getElementById("countriesList");
    const noResults = document.getElementById("noResults");
    const countryItems = document.querySelectorAll(".country-item");

    if (searchInput && countriesList && noResults) {
        searchInput.addEventListener("input", (e) => {
            const query = (e.target as HTMLInputElement).value.toLowerCase();
            let hasResults = false;

            countryItems.forEach((item) => {
                const name = item.getAttribute("data-name") || "";
                const englishName =
                    item.getAttribute("data-english-name") || "";
                if (name.includes(query) || englishName.includes(query)) {
                    (item as HTMLElement).style.display = "flex";
                    hasResults = true;
                } else {
                    (item as HTMLElement).style.display = "none";
                }
            });

            if (hasResults) {
                countriesList.classList.remove("hidden");
                noResults.classList.add("hidden");
            } else {
                countriesList.classList.add("hidden");
                noResults.classList.remove("hidden");
            }
        });
    }
</script>
